<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Setting up alert notifications to Slack - IBM Event Automation</title>
<meta name="description" content="Receive notifications about the health of your cluster based on monitored metrics.">

<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="IBM Event Automation">
<meta property="og:url" content="http://localhost:4000/event-automation/tutorials/monitoring-alerts/" />
<meta property="og:title" content="Tutorials | Setting up alert notifications to Slack" />
<meta property="og:description" content="Receive notifications about the health of your cluster based on monitored metrics." />

<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="IBM Event Automation | Setting up alert notifications to Slack" />




  <meta property="og:description" content="Receive notifications about the health of your cluster based on monitored metrics.">



  <meta property="og:image" content="http://localhost:4000/event-automation/assets/siteMeta/appIcon_og_fb.png">
  <meta name="twitter:image" content="http://localhost:4000/event-automation/assets/siteMeta/appIcon_og_square.png">



  <meta property="article:published_time" content="2023-06-28T12:13:19-04:00">






<link rel="canonical" href="http://localhost:4000/event-automation/tutorials/monitoring-alerts/">





  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "url": "http://localhost:4000/event-automation",
      "logo": "http://localhost:4000/event-automation/assets/siteMeta/appIcon_og_fb.png"
    }
  </script>



  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": null,
      "url": "http://localhost:4000/event-automation",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/event-automation/feed.xml" type="application/atom+xml" rel="alternate" title="IBM Event Automation Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/event-automation/assets/css/main.css">



<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<link rel="apple-touch-icon" sizes="180x180" href="http://localhost:4000/event-automation/assets/siteMeta/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:4000/event-automation/assets/siteMeta/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:4000/event-automation/assets/siteMeta/favicon-16x16.png">
<link rel="manifest" href="http://localhost:4000/event-automation/assets/siteMeta/site.webmanifest">
<link rel="mask-icon" href="http://localhost:4000/event-automation/assets/siteMeta/safari-pinned-tab.svg" color="#000000">
<link rel="shortcut icon" href="http://localhost:4000/event-automation/assets/siteMeta/favicon.ico">
<link rel="shortcut icon" type="image/png" href="http://localhost:4000/event-automation/assets/siteMeta/favicon-16x16.png"/>
<link rel="shortcut icon" type="image/png" href="http://localhost:4000/event-automation/assets/siteMeta/favicon-32x32.png"/>
<meta name="msapplication-TileColor" content="#000000">
<meta name="msapplication-config" content="http://localhost:4000/event-automation/assets/siteMeta/browserconfig.xml">
<meta name="theme-color" content="#000000">



<link href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:400,600%7CIBM+Plex+Serif:300,400,500%7CIBM+Plex+Mono:300,400,500,700" rel="stylesheet">

<!-- end custom head snippets -->

    <link rel="shortcut icon" type="image/x-icon" href="/event-automation/assets/favicon.ico" >
    
    <base target="_parent">

  </head>
  <script src="/event-automation/assets/animation/lottie.js" type="text/javascript"></script>
  <script src="/event-automation/assets/js/connectors.js"></script>


  
  <body onload="" class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    




<div id="masthead" class="masthead">
  <!--
  <div class="masthead__goToIBMCloud">
  <div>
    You are viewing the documentation for the container-native version of IBM Event Automation.
  </div>
    <a class="link" target="_self" href="https://cloud.ibm.com/docs/EventStreams?topic=EventStreams-getting-started">Looking for the managed service on IBM Cloud? Click here.</a>
</div>
-->
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="mastheadNav">

      


        <div class="mastheadTitle">
          
          <a class="site-title" href="/event-automation/" target="_self"><span>IBM</span>&nbsp;Event Automation</a>
          <div class="viewOnIBMcom">
            <a href="https://www.ibm.com/products/event-automation" target="_blank">View product page</a>
          </div>
        </div>









        <div class="mastheadControls">
            <div class="menuScrollContainer">

        

                <ul id="visible-links" class="visible-links">
                  
                  
                  

                  




                  
                    <li class="masthead__menu-item " onclick="window.open('http://localhost:4000/event-automation/es/','_self')">
                      <a href="http://localhost:4000/event-automation/es/" >Event Streams</a>
                    </li>
                  

                  
                  
                  

                  




                  
                    <li class="masthead__menu-item " onclick="window.open('http://localhost:4000/event-automation/eem/','_self')">
                      <a href="http://localhost:4000/event-automation/eem/" >Endpoint Management</a>
                    </li>
                  

                  
                  
                  

                  




                  
                    <li class="masthead__menu-item " onclick="window.open('http://localhost:4000/event-automation/ep/','_self')">
                      <a href="http://localhost:4000/event-automation/ep/" >Event Processing</a>
                    </li>
                  

                  
                  
                  

                  




                  
                    <li class="masthead__menu-item " onclick="window.open('http://localhost:4000/event-automation/connectors/','_self')">
                      <a href="http://localhost:4000/event-automation/connectors/" >Connectors</a>
                    </li>
                  

                  
                  
                  

                  




                  
                    <li class="masthead__menu-item active" onclick="window.open('http://localhost:4000/event-automation/tutorials/','_self')">
                      <a href="http://localhost:4000/event-automation/tutorials/" >Tutorials</a>
                    </li>
                  

                  
                  
                  

                  




                  
                    <li class="masthead__menu-item " onclick="window.open('http://localhost:4000/event-automation/api/','_self')">
                      <a href="http://localhost:4000/event-automation/api/" >APIs...</a>
                    </li>
                  

                  
                  
                  

                  




                  
                    <li class="masthead__menu-item " onclick="window.open('http://localhost:4000/event-automation/support/','_self')">
                      <a href="http://localhost:4000/event-automation/support/" >Support</a>
                    </li>
                  

                  
                  
                  

                  




                  
                    <li class="masthead__menu-item " onclick="window.open('http://localhost:4000/event-automation/search/','_self')">
                      <button aria-label="Search Button" role="button" id="searchButton" class="search__toggle " type="button" name="search Button">
                        <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                          <path
                            d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z"
                            transform="translate(-.01)"></path>
                        </svg>
                      </button>
                    </li>
                  

                  
                </ul>
        

      </div>
    </div>
      </nav>
    </div>
  </div>
</div>


    <div id="initial-content" class="initial-content" role="main">






<main id="main" class="mainContainer" role="main">
    

    
  



  <div class="mainContent">
    
      
      
      <div class="subMenu backMenu"> 
    <a href="
        http://localhost:4000/event-automation/tutorials
      "><img alt="" role="presentation" src="http://localhost:4000/event-automation/assets/images/icons/previous.svg" />
        Back to tutorials
      </a>
  </div>
    
    <div id="pageContainer" class="page" itemscope itemtype="http://schema.org/CreativeWork">
      
      <div class="page__inner-wrap">
      

        
        <section class="page__content pageSpacing" itemprop="text">
          
        
          <header>
            <h1 id="page-title" class="page__title" itemprop="headline">
              Setting up alert notifications to Slack
</h1>
            
          </header>  
        
        

                    
          <div class="content">
            <p>Receiving notifications based on monitored metrics is an important way of keeping an eye on the health of your cluster. You can set up notifications to be sent to applications like Slack based on pre-defined triggers.</p>

<p>The following tutorial shows an example of how to set up alert notifications to be sent to Slack based on metrics from Event Streams.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li>Ensure you have an Event Streams installation available. This tutorial is based on Event Streams version 11.0.2 installed on Red Hat OpenShift Container Platform 4.8.43.</li>
  <li>Ensure you have <a href="https://slack.com/" target="_blank">Slack</a> installed and ready to use. This tutorial is based on Slack version 4.28.171.</li>
  <li>You need to be a Workplace Administrator to add apps to a Slack channel.</li>
</ul>

<h2 id="preparing-slack">Preparing Slack</h2>

<p>To send notifications from Event Streams to your Slack channel, configure an incoming webhook URL within your Slack service. The webhook URL provided by Slack is required for the integration steps later in this section. To create the webhook URL:</p>

<ol>
  <li>Open Slack and go to your Slack channel where you want the notifications to be sent.</li>
  <li>From your Slack channel click the icon for <strong>Channel Settings</strong>, and select <strong>Add apps</strong> or <strong>Add an app</strong> depending on the Slack plan you are using.</li>
  <li>Search for “Incoming Webhooks”.</li>
  <li>Click <strong>Add configuration</strong>.</li>
  <li>Select the channel that you want to post to.</li>
  <li>Click <strong>Add Incoming Webhooks integration</strong>.</li>
  <li>Copy the URL in the <strong>Webhook URL</strong> field.</li>
</ol>

<p>For more information about incoming webhooks in Slack, see the <a href="https://api.slack.com/incoming-webhooks" target="_blank">Slack documentation</a>.</p>

<h2 id="installing-the-prometheus-server">Installing the Prometheus server</h2>

<p>In this tutorial, we will use the Prometheus Operator to launch the Prometheus server and install Prometheus Alertmanager. The Prometheus Operator will initially be implemented in the same namespace as Event Streams. The following resources are required to launch a Prometheus server after installing the Prometheus Operator.</p>

<ul>
  <li>ClusterRole</li>
  <li>ServiceAccount</li>
  <li>ClusterRoleBinding</li>
  <li>Prometheus</li>
</ul>

<p>The YAML file for installing these resources is available on <a href="https://github.com/strimzi/strimzi-kafka-operator/blob/main/examples/metrics/prometheus-install/prometheus.yaml" target="_blank">GitHub</a>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-server</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">strimzi</span>
<span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nodes</span>
      <span class="pi">-</span> <span class="s">nodes/proxy</span>
      <span class="pi">-</span> <span class="s">services</span>
      <span class="pi">-</span> <span class="s">endpoints</span>
      <span class="pi">-</span> <span class="s">pods</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">extensions</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">ingresses</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="na">nonResourceURLs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/metrics"</span><span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">]</span>

<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-server</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">strimzi</span>

<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-server</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">strimzi</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-server</span>
<span class="na">subjects</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-server</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">&lt;namespace&gt;</span>

<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">monitoring.coreos.com/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Prometheus</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">strimzi</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">prometheus-server</span>
  <span class="na">podMonitorSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">strimzi</span>
  <span class="na">serviceMonitorSelector</span><span class="pi">:</span> <span class="pi">{}</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">memory</span><span class="pi">:</span> <span class="s">400Mi</span>
  <span class="na">enableAdminAPI</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">ruleSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">role</span><span class="pi">:</span> <span class="s">alert-rules</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">strimzi</span>
  <span class="na">alerting</span><span class="pi">:</span>
    <span class="na">alertmanagers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">namespace</span><span class="pi">:</span> <span class="s">&lt;namespace&gt;</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">alertmanager</span>
      <span class="na">port</span><span class="pi">:</span> <span class="s">alertmanager</span>
</code></pre></div></div>

<p>Replace <code class="language-plaintext highlighter-rouge">&lt;namespace&gt;</code> with the namespace where your Event Streams instance is installed. After applying this YAML, it will bring up a Prometheus server. You can access the Prometheus server by applying a route that points to the <code class="language-plaintext highlighter-rouge">prometheus-operated</code> service.</p>

<p>The following is an example route to access the Prometheus server.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kind</span><span class="pi">:</span> <span class="s">Route</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">route.openshift.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">&lt;namespace&gt;</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
  <span class="na">to</span><span class="pi">:</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-operated</span>
    <span class="na">weight</span><span class="pi">:</span> <span class="m">100</span>
  <span class="na">port</span><span class="pi">:</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="s">web</span>
</code></pre></div></div>

<h2 id="installing-alertmanager">Installing Alertmanager</h2>

<p>Alertmanager handles alerts sent by client applications such as the Prometheus server. It takes care of deduplicating, grouping, and routing them to the correct receiver integration, for example, email, PagerDuty, or Slack. It also takes care of silencing and inhibiting alerts. For more information about Prometheus Alertmanager, see the <a href="https://prometheus.io/docs/alerting/latest/configuration/" target="_blank">Prometheus documentation</a>.</p>

<p>We will deploy an Alertmanager service in order to create a route to the Alertmanager user interface. The following example deploys an Alertmanager with port 9093 configured for the service.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">monitoring.coreos.com/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Alertmanager</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">alertmanager</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">strimzi</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">alertmanager</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">strimzi</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">alertmanager</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">9093</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">9093</span>
      <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">alertmanager</span><span class="pi">:</span> <span class="s">alertmanager</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
</code></pre></div></div>

<p>The following route provides access to the Alertmanager user interface.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kind</span><span class="pi">:</span> <span class="s">Route</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">route.openshift.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">alertmanager</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">&lt;namespace&gt;</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">path</span><span class="pi">:</span> <span class="s">/</span>
  <span class="na">to</span><span class="pi">:</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">alertmanager-operated</span>
    <span class="na">weight</span><span class="pi">:</span> <span class="m">100</span>
  <span class="na">port</span><span class="pi">:</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="s">web</span>
  <span class="na">wildcardPolicy</span><span class="pi">:</span> <span class="s">None</span>
</code></pre></div></div>

<h2 id="slack-integration">Slack Integration</h2>

<p>Define the Slack channel as the receiver using the incoming webhook you copied earlier, and also set up the notification details such as the channel to post to, the content format, and criteria for the events to send to Slack. Settings to configure include the following:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">slack_api_url</code>: The incoming webhook generated in Slack earlier.</li>
  <li><code class="language-plaintext highlighter-rouge">send_resolved</code>: Set to <code class="language-plaintext highlighter-rouge">true</code> to send notifications about resolved alerts.</li>
  <li><code class="language-plaintext highlighter-rouge">channel</code>: The Slack channel to send the notifications to.</li>
  <li><code class="language-plaintext highlighter-rouge">username</code>: The username that posts the alert notifications to the channel.</li>
</ul>

<p>For more information about the configuration settings to enter for Slack notifications, see the <a href="https://prometheus.io/docs/alerting/configuration/#slack_config" target="_blank">Prometheus documentation</a>.</p>

<p>The content for the posts can be customized, see the following <a href="https://medium.com/quiq-blog/better-slack-alerts-from-prometheus-49125c8c672b" target="_blank">blog</a> for Slack alert examples from Prometheus.</p>

<p>For example, to set up Slack notifications for your alert rule created earlier:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">alertmanager-alertmanager</span>
<span class="na">type</span><span class="pi">:</span> <span class="s">Opaque</span>
<span class="na">stringData</span><span class="pi">:</span>
  <span class="s">alertmanager.yaml</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">global:</span>
      <span class="s">slack_api_url: &lt;slack_api_url&gt;</span>
    <span class="s">route:</span>
      <span class="s">receiver: slack</span>
    <span class="s">receivers:</span>
    <span class="s">- name: slack</span>
      <span class="s">slack_configs:</span>
      <span class="s">- channel: "&lt;channel&gt;"</span>
        <span class="s"># The username to post alerts as</span>
        <span class="s">username: "&lt;username&gt;"</span>

        <span class="s"># An icon for posts in Slack</span>
        <span class="s">icon_url: https://ibm.github.io/event-streams/images/es_icon_light.png</span>

        <span class="s">#</span>
        <span class="s"># The content for posts to Slack when alert conditions are fired</span>
        <span class="s"># Improves on the formatting from the default, with support for handling</span>
        <span class="s">#  alerts containing multiple events.</span>
        <span class="s"># (Modified from the examples in</span>
        <span class="s">#   https://medium.com/quiq-blog/better-slack-alerts-from-prometheus-49125c8c672b)</span>
        <span class="s">title: |-{% raw %}</span>
          <span class="s">[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ if or (and (eq (len .Alerts.Firing) 1) (eq (len .Alerts.Resolved) 0)) (and (eq (len .Alerts.Firing) 0) (eq (len .Alerts.Resolved) 1)) }}{{ range .Alerts.Firing }} @ {{ .Annotations.identifier }}{{ end }}{{ range .Alerts.Resolved }} @ {{ .Annotations.identifier }}{{ end }}{{ end }}</span>
        <span class="s">text: |-</span>
          <span class="s">{{ if or (and (eq (len .Alerts.Firing) 1) (eq (len .Alerts.Resolved) 0)) (and (eq (len .Alerts.Firing) 0) (eq (len .Alerts.Resolved) 1)) }}</span>
          <span class="s">{{ range .Alerts.Firing }}{{ .Annotations.description }}{{ end }}{{ range .Alerts.Resolved }}{{ .Annotations.description }}{{ end }}</span>
          <span class="s">{{ else }}</span>
          <span class="s">{{ if gt (len .Alerts.Firing) 0 }}</span>
          <span class="s">*Alerts Firing:*</span>
          <span class="s">{{ range .Alerts.Firing }}- {{ .Annotations.identifier }}: {{ .Annotations.description }}</span>
          <span class="s">{{ end }}{{ end }}</span>
          <span class="s">{{ if gt (len .Alerts.Resolved) 0 }}</span>
          <span class="s">*Alerts Resolved:*</span>
          <span class="s">{{ range .Alerts.Resolved }}- {{ .Annotations.identifier }}: {{ .Annotations.description }}</span>
          <span class="s">{{ end }}{{ end }}</span>
          <span class="s">{{ end }}</span>
        <span class="s">send_resolved: true</span>
    <span class="no">    </span>
</code></pre></div></div>

<h2 id="selecting-the-metrics-to-monitor">Selecting the metrics to monitor</h2>

<p>In the <code class="language-plaintext highlighter-rouge">EventStreams</code> custom resource, you can configure a ConfigMap path as the <code class="language-plaintext highlighter-rouge">metricsConfig</code>. In the configuration map, you can specify the metrics you want to monitor.</p>

<p>The following is an example of configuring the <code class="language-plaintext highlighter-rouge">metricsConfig</code> in the <code class="language-plaintext highlighter-rouge">EventStreams</code> custom resource:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">metricsConfig</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">jmxPrometheusExporter</span>
  <span class="na">valueFrom</span><span class="pi">:</span>
    <span class="na">configMapKeyRef</span><span class="pi">:</span>
      <span class="na">key</span><span class="pi">:</span> <span class="s">kafka-metrics-config.yaml</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">metrics-config</span>
</code></pre></div></div>

<p>The metrics are exported by means of the JMX Prometheus Exporter. For more information about the exporter, see the following <a href="https://github.com/prometheus/jmx_exporter" target="_blank">Github page</a>.</p>

<p>The following is an example of various metrics that can be collected from both ZooKeeper and Kafka.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kafka-metrics</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">strimzi</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="s">kafka-metrics-config.yaml</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">lowercaseOutputName: true</span>
    <span class="s">rules:</span>
    <span class="s"># Special cases and very specific rules</span>
    <span class="s">- pattern: kafka.server&lt;type=(.+), name=(.+), clientId=(.+), topic=(.+), partition=(.*)&gt;&lt;&gt;Value</span>
      <span class="s">name: kafka_server_$1_$2</span>
      <span class="s">type: GAUGE</span>
      <span class="s">labels:</span>
       <span class="s">clientId: "$3"</span>
       <span class="s">topic: "$4"</span>
       <span class="s">partition: "$5"</span>
    <span class="s">- pattern: kafka.server&lt;type=(.+), partition=(.+)&gt;&lt;&gt;Value</span>
      <span class="s">name: kafka_server_$1_partitioncount</span>
      <span class="s">type: GAUGE</span>
      <span class="s">labels:</span>
       <span class="s">partition: "$1"</span>
    <span class="s">- pattern: kafka.server&lt;type=(.+), name=(.+), clientId=(.+), brokerHost=(.+), brokerPort=(.+)&gt;&lt;&gt;Value</span>
      <span class="s">name: kafka_server_$1_$2</span>
      <span class="s">type: GAUGE</span>
      <span class="s">labels:</span>
       <span class="s">clientId: "$3"</span>
       <span class="s">broker: "$4:$5"</span>
    <span class="s">- pattern: kafka.server&lt;type=(.+), cipher=(.+), protocol=(.+), listener=(.+), networkProcessor=(.+)&gt;&lt;&gt;connections</span>
      <span class="s">name: kafka_server_$1_connections_tls_info</span>
      <span class="s">type: GAUGE</span>
      <span class="s">labels:</span>
        <span class="s">cipher: "$2"</span>
        <span class="s">protocol: "$3"</span>
        <span class="s">listener: "$4"</span>
        <span class="s">networkProcessor: "$5"</span>
    <span class="s">- pattern: kafka.server&lt;type=(.+), clientSoftwareName=(.+), clientSoftwareVersion=(.+), listener=(.+), networkProcessor=(.+)&gt;&lt;&gt;connections</span>
      <span class="s">name: kafka_server_$1_connections_software</span>
      <span class="s">type: GAUGE</span>
      <span class="s">labels:</span>
        <span class="s">clientSoftwareName: "$2"</span>
        <span class="s">clientSoftwareVersion: "$3"</span>
        <span class="s">listener: "$4"</span>
        <span class="s">networkProcessor: "$5"</span>
    <span class="s">- pattern: "kafka.server&lt;type=(.+), listener=(.+), networkProcessor=(.+)&gt;&lt;&gt;(.+):"</span>
      <span class="s">name: kafka_server_$1_$4</span>
      <span class="s">type: GAUGE</span>
      <span class="s">labels:</span>
       <span class="s">listener: "$2"</span>
       <span class="s">networkProcessor: "$3"</span>
    <span class="s">- pattern: kafka.server&lt;type=(.+), listener=(.+), networkProcessor=(.+)&gt;&lt;&gt;(.+)</span>
      <span class="s">name: kafka_server_$1_$4</span>
      <span class="s">type: GAUGE</span>
      <span class="s">labels:</span>
       <span class="s">listener: "$2"</span>
       <span class="s">networkProcessor: "$3"</span>
    <span class="s"># Some percent metrics use MeanRate attribute</span>
    <span class="s"># Ex) kafka.server&lt;type=(KafkaRequestHandlerPool), name=(RequestHandlerAvgIdlePercent)&gt;&lt;&gt;MeanRate</span>
    <span class="s">- pattern: kafka.(\w+)&lt;type=(.+), name=(.+)Percent\w*&gt;&lt;&gt;MeanRate</span>
      <span class="s">name: kafka_$1_$2_$3_percent</span>
      <span class="s">type: GAUGE</span>
    <span class="s"># Generic gauges for percents</span>
    <span class="s">- pattern: kafka.(\w+)&lt;type=(.+), name=(.+)Percent\w*&gt;&lt;&gt;Value</span>
      <span class="s">name: kafka_$1_$2_$3_percent</span>
      <span class="s">type: GAUGE</span>
    <span class="s">- pattern: kafka.(\w+)&lt;type=(.+), name=(.+)Percent\w*, (.+)=(.+)&gt;&lt;&gt;Value</span>
      <span class="s">name: kafka_$1_$2_$3_percent</span>
      <span class="s">type: GAUGE</span>
      <span class="s">labels:</span>
        <span class="s">"$4": "$5"</span>
    <span class="s"># Generic per-second counters with 0-2 key/value pairs</span>
    <span class="s">- pattern: kafka.(\w+)&lt;type=(.+), name=(.+)PerSec\w*, (.+)=(.+), (.+)=(.+)&gt;&lt;&gt;Count</span>
      <span class="s">name: kafka_$1_$2_$3_total</span>
      <span class="s">type: COUNTER</span>
      <span class="s">labels:</span>
        <span class="s">"$4": "$5"</span>
        <span class="s">"$6": "$7"</span>
    <span class="s">- pattern: kafka.(\w+)&lt;type=(.+), name=(.+)PerSec\w*, (.+)=(.+)&gt;&lt;&gt;Count</span>
      <span class="s">name: kafka_$1_$2_$3_total</span>
      <span class="s">type: COUNTER</span>
      <span class="s">labels:</span>
        <span class="s">"$4": "$5"</span>
    <span class="s">- pattern: kafka.(\w+)&lt;type=(.+), name=(.+)PerSec\w*&gt;&lt;&gt;Count</span>
      <span class="s">name: kafka_$1_$2_$3_total</span>
      <span class="s">type: COUNTER</span>
    <span class="s"># Generic gauges with 0-2 key/value pairs</span>
    <span class="s">- pattern: kafka.(\w+)&lt;type=(.+), name=(.+), (.+)=(.+), (.+)=(.+)&gt;&lt;&gt;Value</span>
      <span class="s">name: kafka_$1_$2_$3</span>
      <span class="s">type: GAUGE</span>
      <span class="s">labels:</span>
        <span class="s">"$4": "$5"</span>
        <span class="s">"$6": "$7"</span>
    <span class="s">- pattern: kafka.(\w+)&lt;type=(.+), name=(.+), (.+)=(.+)&gt;&lt;&gt;Value</span>
      <span class="s">name: kafka_$1_$2_$3</span>
      <span class="s">type: GAUGE</span>
      <span class="s">labels:</span>
        <span class="s">"$4": "$5"</span>
    <span class="s">- pattern: kafka.(\w+)&lt;type=(.+), name=(.+)&gt;&lt;&gt;Value</span>
      <span class="s">name: kafka_$1_$2_$3</span>
      <span class="s">type: GAUGE</span>
    <span class="s"># Emulate Prometheus 'Summary' metrics for the exported 'Histogram's.</span>
    <span class="s"># Note that these are missing the '_sum' metric!</span>
    <span class="s">- pattern: kafka.(\w+)&lt;type=(.+), name=(.+), (.+)=(.+), (.+)=(.+)&gt;&lt;&gt;Count</span>
      <span class="s">name: kafka_$1_$2_$3_count</span>
      <span class="s">type: COUNTER</span>
      <span class="s">labels:</span>
        <span class="s">"$4": "$5"</span>
        <span class="s">"$6": "$7"</span>
    <span class="s">- pattern: kafka.(\w+)&lt;type=(.+), name=(.+), (.+)=(.*), (.+)=(.+)&gt;&lt;&gt;(\d+)thPercentile</span>
      <span class="s">name: kafka_$1_$2_$3</span>
      <span class="s">type: GAUGE</span>
      <span class="s">labels:</span>
        <span class="s">"$4": "$5"</span>
        <span class="s">"$6": "$7"</span>
        <span class="s">quantile: "0.$8"</span>
    <span class="s">- pattern: kafka.(\w+)&lt;type=(.+), name=(.+), (.+)=(.+)&gt;&lt;&gt;Count</span>
      <span class="s">name: kafka_$1_$2_$3_count</span>
      <span class="s">type: COUNTER</span>
      <span class="s">labels:</span>
        <span class="s">"$4": "$5"</span>
    <span class="s">- pattern: kafka.(\w+)&lt;type=(.+), name=(.+), (.+)=(.*)&gt;&lt;&gt;(\d+)thPercentile</span>
      <span class="s">name: kafka_$1_$2_$3</span>
      <span class="s">type: GAUGE</span>
      <span class="s">labels:</span>
        <span class="s">"$4": "$5"</span>
        <span class="s">quantile: "0.$6"</span>
    <span class="s">- pattern: kafka.(\w+)&lt;type=(.+), name=(.+)&gt;&lt;&gt;Count</span>
      <span class="s">name: kafka_$1_$2_$3_count</span>
      <span class="s">type: COUNTER</span>
    <span class="s">- pattern: kafka.(\w+)&lt;type=(.+), name=(.+)&gt;&lt;&gt;(\d+)thPercentile</span>
      <span class="s">name: kafka_$1_$2_$3</span>
      <span class="s">type: GAUGE</span>
      <span class="s">labels:</span>
        <span class="s">quantile: "0.$4"</span>
  <span class="s">zookeeper-metrics-config.yaml</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">lowercaseOutputName: true</span>
    <span class="s">rules:</span>
    <span class="s"># replicated Zookeeper</span>
    <span class="s">- pattern: "org.apache.ZooKeeperService&lt;name0=ReplicatedServer_id(\\d+)&gt;&lt;&gt;(\\w+)"</span>
      <span class="s">name: "zookeeper_$2"</span>
      <span class="s">type: GAUGE</span>
    <span class="s">- pattern: "org.apache.ZooKeeperService&lt;name0=ReplicatedServer_id(\\d+), name1=replica.(\\d+)&gt;&lt;&gt;(\\w+)"</span>
      <span class="s">name: "zookeeper_$3"</span>
      <span class="s">type: GAUGE</span>
      <span class="s">labels:</span>
        <span class="s">replicaId: "$2"</span>
    <span class="s">- pattern: "org.apache.ZooKeeperService&lt;name0=ReplicatedServer_id(\\d+), name1=replica.(\\d+), name2=(\\w+)&gt;&lt;&gt;(Packets\\w+)"</span>
      <span class="s">name: "zookeeper_$4"</span>
      <span class="s">type: COUNTER</span>
      <span class="s">labels:</span>
        <span class="s">replicaId: "$2"</span>
        <span class="s">memberType: "$3"</span>
    <span class="s">- pattern: "org.apache.ZooKeeperService&lt;name0=ReplicatedServer_id(\\d+), name1=replica.(\\d+), name2=(\\w+)&gt;&lt;&gt;(\\w+)"</span>
      <span class="s">name: "zookeeper_$4"</span>
      <span class="s">type: GAUGE</span>
      <span class="s">labels:</span>
        <span class="s">replicaId: "$2"</span>
        <span class="s">memberType: "$3"</span>
    <span class="s">- pattern: "org.apache.ZooKeeperService&lt;name0=ReplicatedServer_id(\\d+), name1=replica.(\\d+), name2=(\\w+), name3=(\\w+)&gt;&lt;&gt;(\\w+)"</span>
      <span class="s">name: "zookeeper_$4_$5"</span>
      <span class="s">type: GAUGE</span>
      <span class="s">labels:</span>
        <span class="s">replicaId: "$2"</span>
        <span class="s">memberType: "$3"</span>
</code></pre></div></div>

<p>For example, to test the triggering of alerts, you can monitor the total number of partitions for all topics by using the <code class="language-plaintext highlighter-rouge">kafka_server_replicamanager_partitioncount_value</code> metric. When topics are created, this metric can trigger notifications.</p>

<p>For production environments, a good metric to monitor is the number of under-replicated partitions as it tells you about potential problems with your Kafka cluster, such as load or network problems where the cluster becomes overloaded and followers are not able to catch up on leaders. Under-replicated partitions might be a temporary problem, but if it continues for longer, it probably requires urgent attention. An example is to set up a notification trigger to your Slack channel if the number of under-replicated partitions is greater than 0 for more than a minute. You can do this with the <code class="language-plaintext highlighter-rouge">kafka_server_replicamanager_underreplicatedpartitions_value</code> metric.</p>

<p>The examples in this tutorial show you how to set up monitoring for a number of metrics, with the purpose of testing notification triggers, and also to have a production environment example.</p>

<p><strong>Note:</strong> Not all of the metrics that Kafka uses are published to Prometheus by default. The metrics that are published are controlled by a ConfigMap. You can publish metrics by adding them to the ConfigMap.</p>

<p>For information about the different metrics, see <a href="https://kafka.apache.org/documentation/#monitoring" target="_blank">Monitoring Kafka</a>.</p>

<h2 id="setting-the-alert-rule">Setting the alert rule</h2>

<p>To set up the alert rule and define the trigger criteria, use the <code class="language-plaintext highlighter-rouge">PrometheusRule</code> custom resource.</p>

<p>The following YAML configuration will configure Prometheus rules to deliver various alerts to Slack; for example: <code class="language-plaintext highlighter-rouge">The zookeeper is running out of free storage space</code> or <code class="language-plaintext highlighter-rouge">The consumer group lag is too great</code>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">monitoring.coreos.com/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PrometheusRule</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">role</span><span class="pi">:</span> <span class="s">alert-rules</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">strimzi</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">prometheus-k8s-rules</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">groups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">kafka</span>
    <span class="na">rules</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">KafkaRunningOutOfSpace</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">kubelet_volume_stats_available_bytes{persistentvolumeclaim=~"data(-[0-9]+)?-(.+)-kafka-[0-9]+"} * 100 / kubelet_volume_stats_capacity_bytes{persistentvolumeclaim=~"data(-[0-9]+)?-(.+)-kafka-[0-9]+"} &lt; </span><span class="m">15</span>
      <span class="na">for</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Kafka</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">running</span><span class="nv"> </span><span class="s">out</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">free</span><span class="nv"> </span><span class="s">disk</span><span class="nv"> </span><span class="s">space'</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">There</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">only</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">percent</span><span class="nv"> </span><span class="s">available</span><span class="nv"> </span><span class="s">at</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.persistentvolumeclaim</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">PVC'</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">UnderReplicatedPartitions</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">kafka_server_replicamanager_underreplicatedpartitions &gt; </span><span class="m">0</span>
      <span class="na">for</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Kafka</span><span class="nv"> </span><span class="s">under</span><span class="nv"> </span><span class="s">replicated</span><span class="nv"> </span><span class="s">partitions'</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">There</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">under</span><span class="nv"> </span><span class="s">replicated</span><span class="nv"> </span><span class="s">partitions</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.kubernetes_pod_name</span><span class="nv"> </span><span class="s">}}'</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">AbnormalControllerState</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">sum(kafka_controller_kafkacontroller_activecontrollercount) by (strimzi_io_name) != </span><span class="m">1</span>
      <span class="na">for</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Kafka</span><span class="nv"> </span><span class="s">abnormal</span><span class="nv"> </span><span class="s">controller</span><span class="nv"> </span><span class="s">state'</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">There</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">active</span><span class="nv"> </span><span class="s">controllers</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">cluster'</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">OfflinePartitions</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">sum(kafka_controller_kafkacontroller_offlinepartitionscount) &gt; </span><span class="m">0</span>
      <span class="na">for</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Kafka</span><span class="nv"> </span><span class="s">offline</span><span class="nv"> </span><span class="s">partitions'</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">One</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">more</span><span class="nv"> </span><span class="s">partitions</span><span class="nv"> </span><span class="s">have</span><span class="nv"> </span><span class="s">no</span><span class="nv"> </span><span class="s">leader'</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">UnderMinIsrPartitionCount</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">kafka_server_replicamanager_underminisrpartitioncount &gt; </span><span class="m">0</span>
      <span class="na">for</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Kafka</span><span class="nv"> </span><span class="s">under</span><span class="nv"> </span><span class="s">min</span><span class="nv"> </span><span class="s">ISR</span><span class="nv"> </span><span class="s">partitions'</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">There</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">partitions</span><span class="nv"> </span><span class="s">under</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">min</span><span class="nv"> </span><span class="s">ISR</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.kubernetes_pod_name</span><span class="nv"> </span><span class="s">}}'</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">OfflineLogDirectoryCount</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">kafka_log_logmanager_offlinelogdirectorycount &gt; </span><span class="m">0</span>
      <span class="na">for</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Kafka</span><span class="nv"> </span><span class="s">offline</span><span class="nv"> </span><span class="s">log</span><span class="nv"> </span><span class="s">directories'</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">There</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">offline</span><span class="nv"> </span><span class="s">log</span><span class="nv"> </span><span class="s">directories</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.kubernetes_pod_name</span><span class="nv"> </span><span class="s">}}'</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">ScrapeProblem</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">up{kubernetes_namespace!~"openshift-.+",kubernetes_pod_name=~".+-kafka-[0-9]+"} == </span><span class="m">0</span>
      <span class="na">for</span><span class="pi">:</span> <span class="s">3m</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">major</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Prometheus</span><span class="nv"> </span><span class="s">unable</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">scrape</span><span class="nv"> </span><span class="s">metrics</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.kubernetes_pod_name</span><span class="nv"> </span><span class="s">}}/{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}'</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Prometheus</span><span class="nv"> </span><span class="s">was</span><span class="nv"> </span><span class="s">unable</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">scrape</span><span class="nv"> </span><span class="s">metrics</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.kubernetes_pod_name</span><span class="nv"> </span><span class="s">}}/{{</span><span class="nv"> </span><span class="s">$labels.instance</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">more</span><span class="nv"> </span><span class="s">than</span><span class="nv"> </span><span class="s">3</span><span class="nv"> </span><span class="s">minutes'</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">ClusterOperatorContainerDown</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">count((container_last_seen{container="strimzi-cluster-operator"} &gt; (time() - 90))) &lt; 1 or absent(container_last_seen{container="strimzi-cluster-operator"})</span>
      <span class="na">for</span><span class="pi">:</span> <span class="s">1m</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">major</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Cluster</span><span class="nv"> </span><span class="s">Operator</span><span class="nv"> </span><span class="s">down'</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">The</span><span class="nv"> </span><span class="s">Cluster</span><span class="nv"> </span><span class="s">Operator</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">been</span><span class="nv"> </span><span class="s">down</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">longer</span><span class="nv"> </span><span class="s">than</span><span class="nv"> </span><span class="s">90</span><span class="nv"> </span><span class="s">seconds'</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">KafkaBrokerContainersDown</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">absent(container_last_seen{container="kafka",pod=~".+-kafka-[0-9]+"})</span>
      <span class="na">for</span><span class="pi">:</span> <span class="s">3m</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">major</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s1">'</span><span class="s">All</span><span class="nv"> </span><span class="s">`kafka`</span><span class="nv"> </span><span class="s">containers</span><span class="nv"> </span><span class="s">down</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">CrashLookBackOff</span><span class="nv"> </span><span class="s">status'</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">All</span><span class="nv"> </span><span class="s">`kafka`</span><span class="nv"> </span><span class="s">containers</span><span class="nv"> </span><span class="s">have</span><span class="nv"> </span><span class="s">been</span><span class="nv"> </span><span class="s">down</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">CrashLookBackOff</span><span class="nv"> </span><span class="s">status</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">3</span><span class="nv"> </span><span class="s">minutes'</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">KafkaContainerRestartedInTheLast5Minutes</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">count(count_over_time(container_last_seen{container="kafka"}[5m])) &gt; 2 * count(container_last_seen{container="kafka",pod=~".+-kafka-[0-9]+"})</span>
      <span class="na">for</span><span class="pi">:</span> <span class="s">5m</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s1">'</span><span class="s">One</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">more</span><span class="nv"> </span><span class="s">Kafka</span><span class="nv"> </span><span class="s">containers</span><span class="nv"> </span><span class="s">restarted</span><span class="nv"> </span><span class="s">too</span><span class="nv"> </span><span class="s">often'</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">One</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">more</span><span class="nv"> </span><span class="s">Kafka</span><span class="nv"> </span><span class="s">containers</span><span class="nv"> </span><span class="s">were</span><span class="nv"> </span><span class="s">restarted</span><span class="nv"> </span><span class="s">too</span><span class="nv"> </span><span class="s">often</span><span class="nv"> </span><span class="s">within</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">last</span><span class="nv"> </span><span class="s">5</span><span class="nv"> </span><span class="s">minutes'</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">KafkaUnderreplicatedPartitions</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">sum(kafka_server_replicamanager_underreplicatedpartitions_value) by (job) &gt; </span><span class="m">0</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s">Kafka cluster {{$labels.job}} has underreplicated partitions</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">The Kafka cluster {{$labels.job}} has {{$value}} underreplicated partitions</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">KafkaOfflinePartitions</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">sum(kafka_server_replicamanager_underreplicatedpartitions_value) by (job) &gt; </span><span class="m">0</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">critical</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s">Kafka cluster {{$labels.job}} has offline partitions</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">The Kafka cluster {{$labels.job}} has {{$value}} offline partitions</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">zookeeper</span>
    <span class="na">rules</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">AvgRequestLatency</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">zookeeper_avgrequestlatency &gt; </span><span class="m">10</span>
      <span class="na">for</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Zookeeper</span><span class="nv"> </span><span class="s">average</span><span class="nv"> </span><span class="s">request</span><span class="nv"> </span><span class="s">latency'</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">The</span><span class="nv"> </span><span class="s">average</span><span class="nv"> </span><span class="s">request</span><span class="nv"> </span><span class="s">latency</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.kubernetes_pod_name</span><span class="nv"> </span><span class="s">}}'</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">OutstandingRequests</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">zookeeper_outstandingrequests &gt; </span><span class="m">10</span>
      <span class="na">for</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Zookeeper</span><span class="nv"> </span><span class="s">outstanding</span><span class="nv"> </span><span class="s">requests'</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">There</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">outstanding</span><span class="nv"> </span><span class="s">requests</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.kubernetes_pod_name</span><span class="nv"> </span><span class="s">}}'</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">ZookeeperRunningOutOfSpace</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">kubelet_volume_stats_available_bytes{persistentvolumeclaim=~"data-(.+)-zookeeper-[0-9]+"} &lt; </span><span class="m">5368709120</span>
      <span class="na">for</span><span class="pi">:</span> <span class="s">10s</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Zookeeper</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">running</span><span class="nv"> </span><span class="s">out</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">free</span><span class="nv"> </span><span class="s">disk</span><span class="nv"> </span><span class="s">space'</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">There</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">only</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">bytes</span><span class="nv"> </span><span class="s">available</span><span class="nv"> </span><span class="s">at</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.persistentvolumeclaim</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">PVC'</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">ZookeeperContainerRestartedInTheLast5Minutes</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">count(count_over_time(container_last_seen{container="zookeeper"}[5m])) &gt; 2 * count(container_last_seen{container="zookeeper",pod=~".+-zookeeper-[0-9]+"})</span>
      <span class="na">for</span><span class="pi">:</span> <span class="s">5m</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">warning</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s1">'</span><span class="s">One</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">more</span><span class="nv"> </span><span class="s">Zookeeper</span><span class="nv"> </span><span class="s">containers</span><span class="nv"> </span><span class="s">were</span><span class="nv"> </span><span class="s">restarted</span><span class="nv"> </span><span class="s">too</span><span class="nv"> </span><span class="s">often'</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">One</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">more</span><span class="nv"> </span><span class="s">Zookeeper</span><span class="nv"> </span><span class="s">containers</span><span class="nv"> </span><span class="s">were</span><span class="nv"> </span><span class="s">restarted</span><span class="nv"> </span><span class="s">too</span><span class="nv"> </span><span class="s">often</span><span class="nv"> </span><span class="s">within</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">last</span><span class="nv"> </span><span class="s">5</span><span class="nv"> </span><span class="s">minutes.</span><span class="nv"> </span><span class="s">This</span><span class="nv"> </span><span class="s">alert</span><span class="nv"> </span><span class="s">can</span><span class="nv"> </span><span class="s">be</span><span class="nv"> </span><span class="s">ignored</span><span class="nv"> </span><span class="s">when</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Zookeeper</span><span class="nv"> </span><span class="s">cluster</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">scaling</span><span class="nv"> </span><span class="s">up'</span>
    <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">ZookeeperContainersDown</span>
      <span class="na">expr</span><span class="pi">:</span> <span class="s">absent(container_last_seen{container="zookeeper",pod=~".+-zookeeper-[0-9]+"})</span>
      <span class="na">for</span><span class="pi">:</span> <span class="s">3m</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">severity</span><span class="pi">:</span> <span class="s">major</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="na">summary</span><span class="pi">:</span> <span class="s1">'</span><span class="s">All</span><span class="nv"> </span><span class="s">`zookeeper`</span><span class="nv"> </span><span class="s">containers</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Zookeeper</span><span class="nv"> </span><span class="s">pods</span><span class="nv"> </span><span class="s">down</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">CrashLookBackOff</span><span class="nv"> </span><span class="s">status'</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">All</span><span class="nv"> </span><span class="s">`zookeeper`</span><span class="nv"> </span><span class="s">containers</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Zookeeper</span><span class="nv"> </span><span class="s">pods</span><span class="nv"> </span><span class="s">have</span><span class="nv"> </span><span class="s">been</span><span class="nv"> </span><span class="s">down</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">CrashLookBackOff</span><span class="nv"> </span><span class="s">status</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">3</span><span class="nv"> </span><span class="s">minutes'</span>
</code></pre></div></div>

<h3 id="example-test-setup">Example test setup</h3>

<p>As mentioned earlier, to test the triggering of alerts, you can monitor the total number of partitions for all topics by using the <code class="language-plaintext highlighter-rouge">kafka_server_replicamanager_partitioncount_value</code> metric.</p>

<p>Define an alert rule that creates a notification if the number of partitions increases. To achieve this, add a new rule for <code class="language-plaintext highlighter-rouge">kafka_server_replicamanager_partitioncount_value</code>, and set the trigger conditions in the <code class="language-plaintext highlighter-rouge">expr</code> section, for example:</p>

<p><strong>Note:</strong> In this example, we are setting a threshold value of 50 as the built-in consumer-offsets topic has 50 partitions by default already, and this topic is automatically created the first time a consumer application connects to the cluster. We will create a topic later with 10 partitions to <a href="#testing">test</a> the firing of the alert and the subsequent notification to the Slack channel.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">monitoring.coreos.com/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PrometheusRule</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">role</span><span class="pi">:</span> <span class="s">alert-rules</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">strimzi</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">partition-count</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">&lt;namespace&gt;</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">groups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">kafka</span>
    <span class="na">rules</span><span class="pi">:</span>
      <span class="c1"># Posts an alert if the number of partitions increases</span>
      <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">PartitionCount</span>
        <span class="na">expr</span><span class="pi">:</span> <span class="s">kafka_server_replicamanager_partitioncount_value &gt; </span><span class="m">50</span>
        <span class="na">for</span><span class="pi">:</span> <span class="s">10s</span>
        <span class="na">labels</span><span class="pi">:</span>
          <span class="c1"># Labels should match the alert manager so that it is received by the Slack hook</span>
          <span class="na">severity</span><span class="pi">:</span> <span class="s">critical</span>
        <span class="c1"># The contents of the Slack messages that are posted are defined here</span>
        <span class="na">annotations</span><span class="pi">:</span>
          <span class="na">identifier</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Partition</span><span class="nv"> </span><span class="s">count"</span>
          <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">There</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">partition(s)</span><span class="nv"> </span><span class="s">reported</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">broker</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.kafka</span><span class="nv"> </span><span class="s">}}"</span>

</code></pre></div></div>

<p><strong>Important:</strong> As noted in the prerequisites, this tutorial is based on Red Hat OpenShift Container Platform 4.8.43.</p>

<p>To review your alert rules set up this way, use the <code class="language-plaintext highlighter-rouge">oc get PrometheusRules</code> command, for example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>oc get PrometheusRules
NAME                   AGE
prometheus-k8s-rules   1h
partition-count        1h
</code></pre></div></div>

<h3 id="example-production-setup">Example production setup</h3>

<p>As mentioned earlier, a good metric to monitor in production environments is the metric <code class="language-plaintext highlighter-rouge">kafka_server_replicamanager_underreplicatedpartitions_value</code>, for which we want to define an alert rule that creates a notification if the number of under-replicated partitions is greater than 0 for more than a minute. To achieve this, add a new rule for <code class="language-plaintext highlighter-rouge">kafka_server_replicamanager_underreplicatedpartitions_value</code>, and set the trigger conditions in the <code class="language-plaintext highlighter-rouge">data</code> section, for example:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">monitoring.coreos.com/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PrometheusRule</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">role</span><span class="pi">:</span> <span class="s">alert-rules</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">strimzi</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">monitoring-prometheus-alertrules</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">&lt;namespace&gt;</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">groups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">alert.rules</span>
    <span class="na">rules</span><span class="pi">:</span>
      <span class="c1"># Posts an alert if there are any under-replicated partitions</span>
      <span class="c1">#  for longer than a minute</span>
      <span class="pi">-</span> <span class="na">alert</span><span class="pi">:</span> <span class="s">under_replicated_partitions</span>
        <span class="na">expr</span><span class="pi">:</span> <span class="s">kafka_server_replicamanager_underreplicatedpartitions_value &gt; </span><span class="m">0</span>
        <span class="na">for</span><span class="pi">:</span> <span class="s">1m</span>
        <span class="na">labels</span><span class="pi">:</span>
          <span class="c1"># Labels should match the alert manager so that it is received by the Slack hook</span>
          <span class="na">severity</span><span class="pi">:</span> <span class="s">critical</span>
        <span class="c1"># The contents of the Slack messages that are posted are defined here</span>
        <span class="na">annotations</span><span class="pi">:</span>
          <span class="na">identifier</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Under-replicated</span><span class="nv"> </span><span class="s">partitions"</span>
          <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">There</span><span class="nv"> </span><span class="s">are</span><span class="nv"> </span><span class="s">{%</span><span class="nv"> </span><span class="s">raw</span><span class="nv"> </span><span class="s">%}{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">under-replicated</span><span class="nv"> </span><span class="s">partition(s)</span><span class="nv"> </span><span class="s">reported</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">broker</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$labels.kafka</span><span class="nv"> </span><span class="s">}}"</span>
</code></pre></div></div>

<p><strong>Important:</strong> As noted in the prerequisites, this tutorial is based on Red Hat OpenShift Container Platform 4.8.43.</p>

<p>To review your alert rules set up this way, use the <code class="language-plaintext highlighter-rouge">oc get PrometheusRules</code> command, for example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>oc get PrometheusRules
NAME                          AGE
Under-replicated partitions   1h
</code></pre></div></div>

<p>You can also see the list of alerts in both the Prometheus UI and the Alertmanager UI.</p>

<p>The following are examples from both UIs.</p>

<ul>
  <li>Prometheus Alert Page:</li>
</ul>

<p><img src="/event-automation/images/prometheus_alert_page.png" alt="Prometheus Alert Page" title="Prometheus alert page with list of alerts." /></p>

<ul>
  <li>Alertmanager Home Page:</li>
</ul>

<p><img src="/event-automation/images/alertmanager_home_page.png" alt="Alertmanager Home Page" title="Alertmanager home page with list of alerts." /></p>

<p>Prometheus Sample Alert Rule:</p>

<p><img src="/event-automation/images/alert_rules.png" alt="Prometheus alert rules" title="Screen capture showing the alert rule for the under_replicated_partitions alert in the Prometheus UI." /></p>

<p>Prometheus Sample Alert:</p>

<p><img src="/event-automation/images/alerts.png" alt="Prometheus alert rules" title="Screen capture showing the details for the under_replicated_partitions alert in the Prometheus UI." /></p>

<h2 id="testing">Testing</h2>

<h3 id="example-test-setup-1">Example test setup</h3>

<p>To create a notification for the test setup, create a topic with 10 partitions as follows:</p>

<ol>
  <li>Log in to your Event Streams UI.</li>
  <li>Click the <strong>Topics</strong> tab.</li>
  <li>Click <strong>Create topic</strong>.</li>
  <li>Follow the instructions to create the topic, and set the <strong>Partitions</strong> value to 10.</li>
</ol>

<p>The following notification is sent to the Slack channel when the topic is created:</p>

<p><img src="/event-automation/images/slack_alert_firing_test.png" alt="Alert firing message posted to Slack channel in test example" title="Screen capture showing the firing message posted to the Slack channel by the PartitionCount alert." /></p>

<p>To create a resolution alert, delete the topic you created previously:</p>

<ol>
  <li>Log in to your Event Streams UI.</li>
  <li>Click the <strong>Topics</strong> tab.</li>
  <li>Go to the topic you created and click <img src="/event-automation/images/more_options.png" alt="More options icon" title="Three vertical dots for the more options icon at end of each row." height="30px" width="15px" /> <strong>More options &gt; Delete this topic</strong>.</li>
</ol>

<p>When the topic is deleted, the following resolution alert is posted:</p>

<p><img src="/event-automation/images/slack_alert_resolved_test.png" alt="Alert resolved message posted to Slack channel in test example" title="Screen capture showing the resolved message posted to the Slack channel by the PartitionCount alert." /></p>

<h3 id="example-production-setup-1">Example production setup</h3>

<p>For the production environment example, the following notification is posted to the Slack channel if the number of under-replicated partitions remains above 0 for a minute:</p>

<p><img src="/event-automation/images/slack_alert_firing.png" alt="Alert firing message posted to Slack channel in production example" title="Screen capture showing the firing message posted to the Slack channel by the under_replicated_partitions alert." /></p>

<p>When the cluster recovers, a new resolution alert is posted when the number of under-replicated partitions returns to 0. This is based on the <code class="language-plaintext highlighter-rouge">send_resolved</code> setting (was set to <code class="language-plaintext highlighter-rouge">true</code>).</p>

<p><img src="/event-automation/images/slack_alert_resolved.png" alt="Alert resolved message posted to Slack channel in production example" title="Screen capture showing the resolved message posted to the Slack channel by the under_replicated_partitions alert." /></p>

<h2 id="setting-up-other-notifications">Setting up other notifications</h2>

<p>You can use this example to set up alert notifications to other applications, including <a href="https://prometheus.io/docs/alerting/configuration/#hipchat_config" target="_blank">HipChat</a>, <a href="https://prometheus.io/docs/alerting/configuration/#pagerduty_config" target="_blank">PagerDuty</a>, <a href="https://prometheus.io/docs/alerting/configuration/#email_config" target="_blank">emails</a>, and so on. You can also use this technique to generate HTTP calls, which lets you customize alerts when defining a flow in tools like <a href="https://nodered.org/" target="_blank">Node-RED</a> or <a href="https://developer.ibm.com/integration/docs/" target="_blank">IBM App Connect</a>.</p>

<h3 id="troubleshooting">Troubleshooting</h3>

<p>To obtain more log data, you can increase the logging level for the Alertmanager by modifying the <code class="language-plaintext highlighter-rouge">loglevel</code> custom resource as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spec</span><span class="pi">:</span>
  <span class="na">logLevel</span><span class="pi">:</span> <span class="s">debug</span>
</code></pre></div></div>

          </div>


          
        </section>

        <aside class="sidebar__right ">
          
          <div class="fixedSidebar">
            <nav class="toc">
              <ul class="toc__menu">
  <li><a href="#prerequisites">Prerequisites</a></li>
  <li><a href="#preparing-slack">Preparing Slack</a></li>
  <li><a href="#installing-the-prometheus-server">Installing the Prometheus server</a></li>
  <li><a href="#installing-alertmanager">Installing Alertmanager</a></li>
  <li><a href="#slack-integration">Slack Integration</a></li>
  <li><a href="#selecting-the-metrics-to-monitor">Selecting the metrics to monitor</a></li>
  <li><a href="#setting-the-alert-rule">Setting the alert rule</a>
    <ul>
      <li><a href="#example-test-setup">Example test setup</a></li>
      <li><a href="#example-production-setup">Example production setup</a></li>
    </ul>
  </li>
  <li><a href="#testing">Testing</a>
    <ul>
      <li><a href="#example-test-setup-1">Example test setup</a></li>
      <li><a href="#example-production-setup-1">Example production setup</a></li>
    </ul>
  </li>
  <li><a href="#setting-up-other-notifications">Setting up other notifications</a>
    <ul>
      <li><a href="#troubleshooting">Troubleshooting</a></li>
    </ul>
  </li>
</ul>
            </nav>
          </div>
          
        </aside>


      </div>
      <div class="pageEnd">
        
      </div>
    </div>


  </div> <!-- Main content -->

</main></div>


    
      <div class="page__footer">
          <footer>
            <!-- start custom footer snippets -->

<!-- end custom footer snippets -->

            
<div class="page__footer-copyright"><a href="https://www.ibm.com/privacy/us/en/" rel="nofollow" target="_blank">Privacy Policy</a>  &nbsp;© Copyright IBM Corporation 2023</br>
<a href="http://localhost:4000/event-automation/accessibility/" rel="nofollow" target="_blank">Accessibility</a> </br> <a href="http://localhost:4000/event-automation/notices/" rel="nofollow" target="_blank">Notices</a></br>
          </footer>
      </div>      
    


    
  <script src="/event-automation/assets/js/main.min.js"></script>
  <!-- <script src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script> -->






<script src="/event-automation/assets/js/design.js"></script>





<script src="/event-automation/assets/js/lunr/lunr.min.js"></script>
<script src="/event-automation/assets/js/lunr/lunr-store.js"></script>
<script src="/event-automation/assets/js/lunr/lunr-en.js"></script>





    

    
  </body>
</html>
